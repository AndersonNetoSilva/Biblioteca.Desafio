@page
@model Biblioteca.WebApp.Areas.Admin.Pages.General.Livros.EditModel

@{
    ViewData["Title"] = "Alterar";
}

<breadcrumb items="Cadastros, Gerais, Livros, Alterar"></breadcrumb>

<div class="row">
    <div class="col-md-12">
        <form method="post" enctype="multipart/form-data">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <span class="text-danger">*</span>
                        <label asp-for="Livro.Titulo" class="control-label"></label>
                        <input asp-for="Livro.Titulo" class="form-control" />
                        <span asp-validation-for="Livro.Titulo" class="text-danger"></span>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        <span class="text-danger">*</span>
                        <label asp-for="Livro.Editora" class="control-label"></label>
                        <input asp-for="Livro.Editora" class="form-control" />
                        <span asp-validation-for="Livro.Editora" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <span class="text-danger">*</span>
                        <label asp-for="Livro.Edicao" class="control-label"></label>
                        <input asp-for="Livro.Edicao" class="form-control" />
                        <span asp-validation-for="Livro.Edicao" class="text-danger"></span>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        <span class="text-danger">*</span>
                        <label asp-for="Livro.ValorString" class="control-label"></label>
                        <input asp-for="Livro.ValorString" class="form-control" asp-format="{0:C}" />
                        <span asp-validation-for="Livro.ValorString" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <span class="text-danger">*</span>
                        <label class="control-label">Autores</label>
                        <select asp-for="AutorIds" asp-items="Model.Autores" multiple class="form-control"></select>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        <span class="text-danger">*</span>
                        <label class="control-label">Assuntos</label>
                        <select asp-for="AssuntoIds" asp-items="Model.Assuntos" multiple class="form-control"></select>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb3">
                    <label class="form-label">Imagem</label>
                    <input asp-for="ArquivoImagem.FormFile"
                           type="file"
                           class="form-control"
                           accept="image/*" />
                    <span asp-validation-for="ArquivoImagem.FormFile" class="text-danger"></span>
                </div>

                @if (Model.Livro.ArquivoImagemId > 0)
                {
                    <div class="col-md-4 d-flex flex-column">
                        <label class="form-label">Visualização Imagem</label>
                        <img src="@Url.Page(null, "ConteudoDoArquivo", new { livroId = Model.Livro.Id })"
                             class="img-thumbnail img-fluid align-self-start mt-2"
                             style="max-height: 150px; width: auto; cursor: zoom-in;"
                             data-bs-toggle="modal"
                             data-bs-target="#modalImagemCapa" />
                    </div>
                }
            </div>

            <div class="row">
                <div class="col-md-6 mb3">
                    <label class="form-label">Documento</label>
                    <input asp-for="ArquivoDownload.FormFile"
                           type="file"
                           class="form-control"
                           accept=".pdf,.doc,.docx,.txt,.rtf,.odt,.zip,.rar" />
                    <span asp-validation-for="ArquivoDownload.FormFile" class="text-danger"></span>
                </div>

                @if (Model.Livro.ArquivoDownloadId > 0)
                {
                    <div class="col-md-4 d-flex flex-column">
                        <label class="form-label">Download do Documento</label>
                        <div class="d-flex align-items-center gap-2 mt-2">
                            <a class="btn btn-sm btn-outline-primary"
                               href="@Url.Page(null, "DownloadDoArquivo", new { livroId = Model.Livro.Id })">
                                <i class="bi bi-download"></i>
                                Download
                            </a>
                        </div>
                    </div>
                }
            </div>

            <div class="row">
                <div class="col-md-12">
                    <h5 class="mt-4">Preços de Venda</h5>

                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>
                                    <button type="button" class="btn btn-outline-primary btn-sm p-1"
                                            onclick="adicionarLinha()">
                                        <i class="bi bi-plus-circle"></i>
                                    </button>
                                </th>
                                <th></th>
                                <th>Tipo</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        @*  Edição In-Line do Grid. 
                            Todas as Colunas São Editáveis.

                            <tbody>
                            @for (int i = 0; i < Model.PrecosDeVenda.Count; i++)
                            {
                                <tr data-index="@i">
                                    <td>
                                        <button type="button" class="btn btn-outline-danger btn-sm p-1"
                                                onclick="marcarParaExclusao(this, 'PrecosDeVenda');">
                                            <i class="bi bi-trash"></i>
                                        </button>

                                        <input type="hidden" asp-for="PrecosDeVenda[@i].Id" />
                                        <input type="hidden" asp-for="PrecosDeVenda[@i].MarcadoParaExclusao" />
                                    </td>
                                    <td>
                                        <select asp-for="PrecosDeVenda[@i].Tipo"
                                                asp-items="Html.GetEnumSelectList<Biblioteca.WebApp.Model.TipoDeVenda>()"
                                                class="form-select">
                                        </select>
                                    </td>
                                    <td>
                                        <input asp-for="PrecosDeVenda[@i].ValorString" class="form-control" asp-format="{0:C}" />
                                        <span asp-validation-for="PrecosDeVenda[@i].ValorString" class="text-danger"></span>
                                    </td>
                                </tr>
                            }
                        </tbody> *@

                        @* 
                            Ediçao no Grid com Linha Expansível
                            As Colunas do Grid São Somente Leitura e uma Linha adicional é Exibida com o painel de Edição
                        *@

                        <tbody id="precosBody">
                            @for (int i = 0; i < Model.PrecosDeVenda.Count; i++)
                            {
                                <tr class="display-row" data-index="@i">
                                    <td class="text-center text-nowrap" style="width:1%">
                                        <button type="button" class="btn btn-sm btn-outline-secondary btn-sm p-1"
                                                onclick="toggleEditor(this)">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    </td>
                                    <td class="text-center text-nowrap" style="width:1%">
                                        <button type="button" class="btn btn-outline-danger btn-sm p-1"
                                                onclick="marcarParaExclusao(this, 'PrecosDeVenda');">
                                            <i class="bi bi-trash"></i>
                                        </button>

                                        <input type="hidden" asp-for="PrecosDeVenda[@i].Id" />
                                        <input type="hidden" asp-for="PrecosDeVenda[@i].MarcadoParaExclusao" />
                                    </td>
                                    <td class="tipo-text">@Html.DisplayFor(modelItem => Model.PrecosDeVenda[@i].Tipo)</td>
                                    <td class="valor-text">@Html.DisplayFor(modelItem => Model.PrecosDeVenda[@i].ValorString)</td>
                                </tr>

                                <tr class="editor-row d-none" data-index="@i">
                                    <td colspan="4" class="p-0">
                                        <div class="bg-body-secondary border-start border-4 border-primary rounded-3 p-3">
                                            <div class="row mt-2">
                                                <div class="col-md-4">
                                                    <label asp-for="PrecosDeVenda[@i].Tipo" class="control-label"></label>
                                                    <select asp-for="PrecosDeVenda[@i].Tipo"
                                                            asp-items="Html.GetEnumSelectList<Biblioteca.WebApp.Model.TipoDeVenda>()"
                                                            class="form-select">
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row  mt-2">
                                                <div class="col-md-4">
                                                    <label asp-for="PrecosDeVenda[@i].ValorString" class="control-label"></label>
                                                    <input asp-for="PrecosDeVenda[@i].ValorString" class="form-control" asp-format="{0:C}" />
                                                    <span asp-validation-for="PrecosDeVenda[@i].ValorString" class="text-danger"></span>
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-12 d-flex justify-content-end gap-2">
                                                    <button type="button"
                                                            class="btn btn-sm btn-outline-secondary"
                                                            style="width: 48px; height: 40px;"
                                                            onclick="confirmarEdicao(this)">
                                                        <i class="bi bi-check-lg"></i>
                                                    </button>

                                                    <button type="button"
                                                            class="btn btn-outline-danger btn-sm p-1"
                                                            style="width: 48px; height: 40px;"
                                                            onclick="fecharEditor(this)">
                                                        <i class="bi bi-door-open"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <h5 class="mt-4">Anexos</h5>

                    <table id="tabelaAnexos" class="table table-sm">
                        <thead>
                            <tr>
                                <th>
                                    <button type="button" class="btn btn-outline-primary btn-sm p-1"
                                            onclick="adicionarAnexo()">
                                        <i class="bi bi-plus-circle"></i>
                                    </button>
                                </th>
                                <th>Descrição</th>
                                <th>Tipo</th>
                                <th>Arquivo</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.AnexosDoLivro.Count; i++)
                            {
                                <tr data-index="@i">
                                    <td>
                                        <button type="button" class="btn btn-outline-danger btn-sm p-1"
                                                onclick="marcarParaExclusao(this, 'AnexosDoLivro');">
                                            <i class="bi bi-trash"></i>
                                        </button>

                                        <input type="hidden" asp-for="AnexosDoLivro[@i].Id" />
                                        <input type="hidden" asp-for="AnexosDoLivro[@i].MarcadoParaExclusao" />
                                    </td>
                                    <td>
                                        <input asp-for="AnexosDoLivro[@i].Descricao" class="form-control" />
                                        <span asp-validation-for="AnexosDoLivro[@i].Descricao" class="text-danger"></span>
                                    </td>
                                    <td>
                                        @Model.AnexosDoLivro[i].Tipo
                                    </td>
                                    <td>
                                        <input asp-for="AnexosDoLivro[@i].FormFile"
                                               type="file"
                                               class="form-control"
                                               accept="*" />
                                        <span asp-validation-for="AnexosDoLivro[@i].FormFile" class="text-danger"></span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2 mt-2">
                                            <a class="btn btn-sm btn-outline-primary"
                                               href="@Url.Page(null, "DownloadDoAnexoDoLivro", new { livroId = Model.Livro.Id, anexoId = Model.AnexosDoLivro[i].Id })">
                                                <i class="bi bi-download"></i>
                                                Download
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>


            <input type="hidden" asp-for="Livro.Id" />
            <input type="hidden" asp-for="Livro.ArquivoImagemId" />
            <input type="hidden" asp-for="Livro.ArquivoDownloadId" />

            <div class="form-group mt-3 d-flex justify-content-between">
                <input type="submit" value="Gravar" class="btn btn-primary" />

                <a asp-page="./Index" class="btn btn-secondary">Voltar</a>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="modalImagemCapa" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-transparent border-0 d-flex justify-content-center">
            <button type="button"
                    class="btn-close btn-close-white position-absolute top-0 end-0 m-3"
                    data-bs-dismiss="modal"
                    aria-label="Close"></button>

            <img src="@Url.Page(null, "ConteudoDoArquivo", new { livroId = Model.Livro.Id })"
                 class="img-thumbnail"
                 style="max-height: 600px; max-width: 100%; height: auto; width: auto;"
                 alt="Capa do Livro" />
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
                                let contador = `@Model.PrecosDeVenda.Count`;
                                    let contadorAnexo = `@Model.AnexosDoLivro.Count`;

                                const tipoOptions = `@Html.Raw(string.Join("",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Enum.GetValues(typeof(Biblioteca.WebApp.Model.TipoDeVenda))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            .Cast<Biblioteca.WebApp.Model.TipoDeVenda>()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            .Select(e => $"<option value='{(int)e}'>{e}</option>")))`;

    function adicionarLinha() {
        const tbody = document.querySelector('table tbody');

            // Linha de exibição
            const linhaDisplay = document.createElement('tr');
            linhaDisplay.classList.add('display-row');
            linhaDisplay.dataset.index = contador;
            linhaDisplay.innerHTML = `
                <td class="text-center text-nowrap" style="width:1%">
                    <button type="button" class="btn btn-sm btn-outline-secondary btn-sm p-1"
                            onclick="toggleEditor(this)">
                        <i class="bi bi-pencil"></i>
                    </button>
                </td>
                <td class="text-center text-nowrap" style="width:1%">
                    <button type="button" class="btn btn-outline-danger btn-sm p-1"
                            onclick="marcarParaExclusao(this, 'PrecosDeVenda');">
                        <i class="bi bi-trash"></i>
                    </button>
                    <input type="hidden" name="PrecosDeVenda[${contador}].Id" value="0" />
                    <input type="hidden" name="PrecosDeVenda[${contador}].MarcadoParaExclusao" value="false" />
                </td>
                <td class="tipo-text"></td>
                <td class="valor-text"></td>
            `;
            tbody.appendChild(linhaDisplay);

            // Linha de edição (editor)
            const linhaEditor = document.createElement('tr');
            linhaEditor.classList.add('editor-row');
            linhaEditor.dataset.index = contador;
            linhaEditor.innerHTML = `
                <td colspan="4" class="p-0">
                    <div class="bg-body-secondary border-start border-4 border-primary rounded-3 p-3">
                        <div class="row mt-2">
                            <div class="col-md-4">
                                <label class="control-label">Tipo</label>
                                <select name="PrecosDeVenda[${contador}].Tipo" class="form-select">
                                    ${tipoOptions}
                                </select>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-4">
                                <label class="control-label">Valor</label>
                                <input name="PrecosDeVenda[${contador}].ValorString" class="form-control" />
                                <span class="text-danger"></span>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12 d-flex justify-content-end gap-2">
                                <button type="button"
                                        class="btn btn-sm btn-outline-secondary"
                                        style="width: 48px; height: 40px;"
                                        onclick="confirmarEdicao(this)">
                                    <i class="bi bi-check-lg"></i>
                                </button>
                                <button type="button"
                                        class="btn btn-outline-danger btn-sm p-1"
                                        style="width: 48px; height: 40px;"
                                        onclick="fecharEditor(this)">
                                    <i class="bi bi-door-open"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </td>
            `;
            tbody.appendChild(linhaEditor);

            contador++;
        }

                                function adicionarAnexo() {
                                                const tbody = document.querySelector('#tabelaAnexos tbody');

                                                const novaLinha = document.createElement('tr');
                                                novaLinha.innerHTML = `
                                                    <td>
                                                        <button type="button" class="btn btn-outline-danger btn-sm p-1"
                                                                onclick="marcarParaExclusao(this, 'AnexosDoLivro');">
                                                            <i class="bi bi-trash"></i>
                                                        </button>

                                                            <input type="hidden" name="AnexosDoLivro[${contadorAnexo}].Id" value="0"/>
                                                            <input type="hidden" name="AnexosDoLivro[${contadorAnexo}].MarcadoParaExclusao" value="false"/>
                                                    </td>
                                                    <td>
                                                            <input name="AnexosDoLivro[${contadorAnexo}].Descricao" class="form-control" />
                                                            <span class="text-danger field-validation-valid"
                                                                               data-valmsg-for="AnexosDoLivro[${contadorAnexo}].Descricao"
                                                                   data-valmsg-replace="true"></span>
                                                    </td>
                                                    <td>
                                                            <input name="AnexosDoLivro[${contadorAnexo}].FormFile"
                                                               type="file"
                                                               class="form-control"
                                                               accept="*" />
                                                    </td>
                                                `;

                                                tbody.appendChild(novaLinha);
                                                contadorAnexo++;
                                            }

                                function marcarParaExclusao(button, arrayName) {
                                    const row = button.closest('tr');

                                    const hidden = row.querySelector(
                                        `input[type="hidden"][name^="${arrayName}["][name$=".MarcadoParaExclusao"]`
                                    );

                                    if (!hidden) return;

                                    hidden.value = "true";

                                    row.classList.add('table-danger', 'text-muted');

                                    button.disabled = true;
                                };

                                // Funções para Abrir e Fechar o Editor com Linha Expansível no Gird

                                function toggleEditor(btn) {
                                    const row = btn.closest('tr');
                                    const index = row.dataset.index;
                                    const editor = document.querySelector(`.editor-row[data-index="${index}"]`);
                                    editor.classList.toggle('d-none');
                                }

                                function confirmarEdicao(btn) {
                                    const editor = btn.closest('.editor-row');
                                    const index = editor.dataset.index;

                                    // pega valores do painel. Só pega os que forem ser exibidos no grid.
                                    // No caso do combo, se pegar value vai vir o índice.
                                    const tipo = editor.querySelector(`[name="PrecosDeVenda[${index}].Tipo"] option:checked`).textContent;
                                    const valor = editor.querySelector(`[name="PrecosDeVenda[${index}].ValorString"]`).value;

                                    // encontra a linha do grid correspondente
                                    const row = document.querySelector(`tr[data-index="${index}"]`);
                                    console.log(row);

                                    // atualiza os inputs que o ASP.NET vai bindar
                                    row.querySelector('.tipo-text').textContent = tipo;
                                    row.querySelector('.valor-text').textContent = valor;

                                    fecharEditor(btn);
                                }

                                function fecharEditor(btn) {

                                    const editor = btn.closest('.editor-row');

                                    editor.classList.add('d-none');

                                    $.validator.unobtrusive.parse(editor);
                                }
    </script>
}
